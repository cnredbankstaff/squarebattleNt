<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parkour Boss Battle: Enraged Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body { box-sizing: border-box; }
    canvas { display: block; }
    .health-bar { transition: width 0.2s ease-out; }
    @keyframes boss-glow {
      0%, 100% { box-shadow: 0 0 20px #ff0000; }
      50% { box-shadow: 0 0 40px #ff0000; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full m-0 p-0 overflow-hidden font-mono bg-slate-950">
  <div id="game-container" class="h-full w-full relative select-none"><!-- Start Screen -->
   <div id="start-screen" class="absolute inset-0 flex flex-col items-center justify-center z-50 bg-slate-900 text-white">
    <h1 id="game-title" class="text-6xl font-bold mb-4 text-cyan-400 drop-shadow-[0_0_15px_rgba(34,211,238,0.8)]">BOSS BATTLE</h1>
    <p class="mb-8 text-slate-400 text-center">Find the Portal. Survive the Nightmare.<br>
     Space/Up to Double Jump.</p><button id="start-btn" class="bg-cyan-500 hover:bg-cyan-400 text-slate-900 px-12 py-4 rounded-full font-black text-2xl transition-transform hover:scale-110">START</button>
   </div><!-- HUD -->
   <div id="hud" class="absolute top-4 left-4 right-4 hidden z-40 flex justify-between">
    <div class="w-64">
     <div class="text-cyan-400 text-xs mb-1">
      PLAYER VITALITY
     </div>
     <div class="h-4 bg-slate-800 border border-cyan-500 rounded-full overflow-hidden">
      <div id="player-hp" class="health-bar h-full bg-cyan-500 w-full"></div>
     </div>
    </div>
    <div id="boss-hud" class="w-64 opacity-0 transition-opacity duration-500">
     <div class="text-red-500 text-xs mb-1 text-right">
      ANCIENT TERROR
     </div>
     <div class="h-4 bg-slate-800 border border-red-500 rounded-full overflow-hidden">
      <div id="boss-hp" class="health-bar h-full bg-red-600 w-full"></div>
     </div>
    </div>
   </div><!-- Death Screen -->
   <div id="death-screen" class="absolute inset-0 hidden flex-col items-center justify-center z-50 bg-black/80">
    <h2 class="text-7xl text-red-600 font-black mb-8">YOU PERISHED</h2><button id="retry-btn" class="border-2 border-red-600 text-red-600 px-10 py-3 hover:bg-red-600 hover:text-white transition-colors">RETRY</button>
   </div><!-- Victory Screen -->
   <div id="victory-screen" class="absolute inset-0 hidden flex-col items-center justify-center z-50 bg-black/80">
    <h2 class="text-7xl text-yellow-400 font-black mb-4">VICTORY!</h2>
    <p class="text-2xl text-yellow-300 mb-8">You defeated the Ancient Terror!</p><button id="playagain-btn" class="border-2 border-yellow-400 text-yellow-400 px-10 py-3 hover:bg-yellow-400 hover:text-black transition-colors">PLAY AGAIN</button>
   </div>
   <canvas id="game-canvas"></canvas>
  </div>
  <script>
    // Config and SDK Setup
    const defaultConfig = {
      game_title: 'BOSS BATTLE',
      level_difficulty: '3'
    };

    let config = { ...defaultConfig };

    function applyConfig() {
      const titleEl = document.getElementById('game-title');
      if (titleEl) {
        titleEl.textContent = config.game_title || defaultConfig.game_title;
      }
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...newConfig };
          applyConfig();
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['game_title', cfg.game_title || defaultConfig.game_title],
          ['level_difficulty', cfg.level_difficulty || defaultConfig.level_difficulty]
        ])
      });
      config = window.elementSdk.config || defaultConfig;
    }

    applyConfig();

    // Game Canvas Setup
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    
    let gameState = 'start';
    let cameraX = 0;
    const gravity = 0.6;
    const levelWidth = 3500;
    
    const player = {
      x: 100, y: 300, w: 35, h: 35,
      vx: 0, vy: 0, 
      hp: 100, maxHp: 100,
      jumps: 0, maxJumps: 2,
      onGround: false, speed: 6, jumpPower: -13,
      lastJumpPressed: false,
      invincible: 0
    };

    const boss = {
      x: 2900, y: 100, w: 120, h: 120,
      vx: 3, vy: 0, hp: 300, maxHp: 300,
      active: false,
      attackTimer: 0,
      jumpTimer: 0,
      phase: 1
    };

    const portal = { x: 2500, y: 250, w: 80, h: 100, active: true };
    let projectiles = [];
    let particles = [];

    const platforms = [
      {x: 0, y: 450, w: 400, h: 40},
      {x: 500, y: 380, w: 150, h: 20},
      {x: 750, y: 300, w: 150, h: 20},
      {x: 1000, y: 220, w: 100, h: 20},
      {x: 1250, y: 350, w: 200, h: 20},
      {x: 1600, y: 280, w: 100, h: 20},
      {x: 1900, y: 400, w: 300, h: 20},
      {x: 2300, y: 350, w: 300, h: 20},
      {x: 2700, y: 500, w: 800, h: 40},
      {x: 2800, y: 350, w: 150, h: 20},
      {x: 3200, y: 350, w: 150, h: 20},
      {x: 3000, y: 200, w: 200, h: 20}
    ];

    const keys = {};
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    function checkCollision(r1, r2) {
      return r1.x < r2.x + (r2.w || r2.width) && r1.x + (r1.w || r1.width) > r2.x &&
             r1.y < r2.y + (r2.h || r2.height) && r1.y + (r1.h || r1.height) > r2.y;
    }

    function createParticles(x, y, color, count = 10) {
      for (let i = 0; i < count; i++) {
        particles.push({
          x: x,
          y: y,
          vx: (Math.random() - 0.5) * 8,
          vy: (Math.random() - 0.5) * 8 - 2,
          life: 1,
          color: color,
          size: Math.random() * 6 + 2
        });
      }
    }

    function update() {
      if (gameState !== 'playing') return;

      // Player Movement
      if (keys['ArrowLeft'] || keys['KeyA']) player.vx = -player.speed;
      else if (keys['ArrowRight'] || keys['KeyD']) player.vx = player.speed;
      else player.vx *= 0.8;

      // Double Jump Logic
      const jumpKey = keys['Space'] || keys['ArrowUp'] || keys['KeyW'];
      if (jumpKey && !player.lastJumpPressed) {
        if (player.onGround) {
          player.vy = player.jumpPower;
          player.jumps = 1;
          player.onGround = false;
        } else if (player.jumps < player.maxJumps) {
          player.vy = player.jumpPower * 0.9;
          player.jumps++;
        }
      }
      player.lastJumpPressed = jumpKey;

      player.vy += gravity;
      player.x += player.vx;
      player.y += player.vy;

      // Platform Collisions
      player.onGround = false;
      platforms.forEach(p => {
        if (checkCollision(player, p)) {
          if (player.vy > 0 && player.y + player.h - player.vy <= p.y) {
            player.y = p.y - player.h;
            player.vy = 0;
            player.onGround = true;
            player.jumps = 0;
          }
        }
      });

      // Camera
      cameraX = player.x - canvas.width / 2;
      cameraX = Math.max(0, Math.min(cameraX, levelWidth - canvas.width));

      // Portal
      if (checkCollision(player, portal)) {
        player.x = 2800;
        player.y = 400;
        boss.active = true;
        document.getElementById('boss-hud').style.opacity = '1';
      }

      // Boss AI
      if (boss.active) {
        boss.vy += gravity;
        boss.y += boss.vy;
        boss.x += boss.vx;

        // Boss Floor Collision
        platforms.forEach(p => {
          if (checkCollision(boss, p)) {
            if (boss.vy > 0 && boss.y + boss.h - boss.vy <= p.y) {
              boss.y = p.y - boss.h;
              boss.vy = 0;
            }
          }
        });

        // Arena Bounds
        if (boss.x < 2700 || boss.x > 3380) boss.vx *= -1;

        // Attack: Ranged
        boss.attackTimer++;
        if (boss.attackTimer > (boss.phase === 2 ? 40 : 80)) {
          projectiles.push({
            x: boss.x + boss.w/2, y: boss.y + boss.h/2,
            vx: player.x < boss.x ? -7 : 7, vy: (player.y - boss.y) * 0.02,
            r: 10
          });
          boss.attackTimer = 0;
        }

        // Attack: Jump on Player
        boss.jumpTimer++;
        if (boss.jumpTimer > 150) {
          boss.vy = -15;
          boss.vx = (player.x - boss.x) * 0.03;
          boss.jumpTimer = 0;
        }

        // Damage Player
        if (checkCollision(player, boss)) {
          if (player.vy > 0 && player.y < boss.y + 20) {
            boss.hp -= 20;
            createParticles(boss.x + boss.w/2, boss.y + boss.h/2, '#ef4444', 15);
            player.vy = -10;
            if (boss.hp < 150) boss.phase = 2;
          } else if (player.invincible <= 0) {
            player.hp -= 1;
            player.invincible = 30;
            createParticles(player.x + player.w/2, player.y + player.h/2, '#22d3ee', 10);
          }
        }
      }

      // Projectiles
      projectiles.forEach((p, i) => {
        p.x += p.vx;
        p.y += p.vy;
        if (checkCollision(player, {x: p.x-p.r, y: p.y-p.r, w: p.r*2, h: p.r*2})) {
          if (player.invincible <= 0) {
            player.hp -= 10;
            player.invincible = 30;
            createParticles(player.x + player.w/2, player.y + player.h/2, '#22d3ee', 10);
          }
          projectiles.splice(i, 1);
        }
      });

      // Update particles
      particles = particles.filter(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.2;
        p.life -= 0.02;
        return p.life > 0;
      });

      if (player.invincible > 0) player.invincible--;

      // UI Update
      document.getElementById('player-hp').style.width = player.hp + '%';
      document.getElementById('boss-hp').style.width = (boss.hp / boss.maxHp * 100) + '%';

      if (player.hp <= 0 || player.y > 1000) {
        gameState = 'over';
        document.getElementById('death-screen').style.display = 'flex';
      }
      if (boss.hp <= 0) {
        gameState = 'victory';
        document.getElementById('victory-screen').style.display = 'flex';
        createParticles(boss.x + boss.w/2, boss.y + boss.h/2, '#facc15', 50);
      }
    }

    function drawParticles() {
      particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x - cameraX, p.y, p.size, p.size);
      });
      ctx.globalAlpha = 1;
    }

    function draw() {
      ctx.fillStyle = '#0f172a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.save();
      ctx.translate(-cameraX, 0);

      // Draw Platforms
      ctx.fillStyle = '#334155';
      platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));

      // Draw Portal
      ctx.fillStyle = '#8b5cf6';
      ctx.shadowBlur = 20;
      ctx.shadowColor = '#a78bfa';
      ctx.fillRect(portal.x, portal.y, portal.w, portal.h);
      ctx.shadowBlur = 0;

      // Draw Player
      if (player.invincible > 0 && Math.floor(player.invincible / 5) % 2 === 0) {
        ctx.globalAlpha = 0.5;
      }
      ctx.fillStyle = '#22d3ee';
      ctx.fillRect(player.x, player.y, player.w, player.h);
      ctx.globalAlpha = 1;

      // Draw Boss
      if (boss.active) {
        ctx.fillStyle = boss.phase === 2 ? '#ef4444' : '#991b1b';
        ctx.fillRect(boss.x, boss.y, boss.w, boss.h);
        
        // Eyes
        ctx.fillStyle = 'yellow';
        ctx.fillRect(boss.x + 20, boss.y + 30, 20, 20);
        ctx.fillRect(boss.x + 80, boss.y + 30, 20, 20);
        
        // Phase 2 glow
        if (boss.phase === 2) {
          ctx.strokeStyle = 'rgba(239, 68, 68, 0.6)';
          ctx.lineWidth = 3;
          ctx.strokeRect(boss.x - 5, boss.y - 5, boss.w + 10, boss.h + 10);
        }
      }

      // Draw Projectiles
      ctx.fillStyle = '#f87171';
      projectiles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fill();
      });

      drawParticles();

      ctx.restore();
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    window.addEventListener('resize', resize);
    resize();

    function startGame() {
      document.getElementById('start-screen').style.display = 'none';
      document.getElementById('hud').classList.remove('hidden');
      gameState = 'playing';
      loop();
    }

    function resetGame() {
      gameState = 'start';
      cameraX = 0;
      
      player.x = 100;
      player.y = 300;
      player.vx = 0;
      player.vy = 0;
      player.hp = 100;
      player.jumps = 0;
      player.onGround = false;
      player.lastJumpPressed = false;
      player.invincible = 0;

      boss.x = 2900;
      boss.y = 100;
      boss.vx = 3;
      boss.vy = 0;
      boss.hp = 300;
      boss.active = false;
      boss.attackTimer = 0;
      boss.jumpTimer = 0;
      boss.phase = 1;

      projectiles = [];
      particles = [];

      document.getElementById('start-screen').style.display = 'flex';
      document.getElementById('hud').classList.add('hidden');
      document.getElementById('death-screen').style.display = 'none';
      document.getElementById('victory-screen').style.display = 'none';
      document.getElementById('boss-hud').style.opacity = '0';

      startGame();
    }

    document.getElementById('start-btn').onclick = startGame;
    document.getElementById('retry-btn').onclick = resetGame;
    document.getElementById('playagain-btn').onclick = resetGame;
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c8d76da777d1c3f',t:'MTc3MDI0MjY3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
